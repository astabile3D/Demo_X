<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin – Piatti 3D</title>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<style>
  body{font:14px system-ui;margin:0;background:#0e0e0e;color:#eee}
  header{padding:12px 16px;border-bottom:1px solid #333}
  main{padding:16px;max-width:1100px;margin:0 auto}
  .card{border:1px solid #333;border-radius:12px;padding:12px;margin:10px 0;background:#151515}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .left{flex:1 1 280px}
  .right{flex:2 1 480px}
  model-viewer{width:100%;height:420px;background:#000;border-radius:12px}
  code{background:#1d1d1d;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<header><b>Admin – Piatti 3D</b></header>
<main>
  <div id="list"></div>
</main>

<script>
const repoOwner = "<TUO-USER-ORG>";
const repoName  = "<TUO-REPO>";
const branch    = "main";

async function fetchJSON(url){ const r=await fetch(url); if(!r.ok) return null; return r.json(); }
function qrURL(id){ return `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(viewURL(id))}`; }
function viewURL(id){ return `https://${repoOwner}.github.io/${repoName}/items/${id}/index.html`; }

async function load(){
  const idxUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branch}/data/index.json?${Date.now()}`;
  const index = (await fetchJSON(idxUrl))||[];
  index.sort((a,b)=>b.createdAt-a.createdAt);

  const list = document.getElementById('list'); list.innerHTML='';
  for (const it of index){
    const glbURL = `https://${repoOwner}.github.io/${repoName}/items/${it.id}/model.glb`;
    const exists = await fetch(glbURL,{method:'HEAD'}).then(r=>r.ok).catch(()=>false);
    const status = exists ? 'ready' : (it.status||'processing');

    const card=document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="row">
        <div class="left">
          <h3 style="margin:0">${it.title||it.id}</h3>
          <div>Stato: <code>${status}</code></div>
          <div>ID: <code>${it.id}</code></div>
          <div style="margin-top:8px">
            <img src="${qrURL(it.id)}" alt="QR">
          </div>
          <div style="margin-top:8px">
            <a href="${viewURL(it.id)}" target="_blank">Apri pagina pubblica ▶</a>
          </div>
        </div>
        <div class="right">
          ${exists ? `<model-viewer src="${glbURL}" camera-controls shadow-intensity="0.7" environment-image="neutral" ar ar-modes="webxr scene-viewer quick-look"></model-viewer>`
                   : `<div style="opacity:.8">In lavorazione… aggiorna tra poco.</div>`}
        </div>
      </div>
    `;
    list.appendChild(card);
  }
}
load();
</script>
</body>
</html>
