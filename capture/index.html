<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cattura Piatto 3D – Demo</title>
<style>
  body{font:14px system-ui;margin:0;background:#111;color:#eee}
  header{padding:12px 16px;border-bottom:1px solid #333}
  main{padding:16px}
  video,canvas{width:100%;max-width:480px;border-radius:12px;background:#000}
  .row{margin:12px 0}
  button{padding:10px 14px;border:0;border-radius:10px;background:#2d6cdf;color:#fff;cursor:pointer}
  button:disabled{opacity:.5}
  .thumbs img{width:70px;height:70px;object-fit:cover;margin:4px;border-radius:8px;border:1px solid #333}
  .hint{opacity:.8}
  input,select{padding:10px;border-radius:10px;border:1px solid #333;background:#161616;color:#eee;width:100%}
</style>
</head>
<body>
<header>
  <b>Cattura Piatto 3D</b>
</header>
<main>
  <div class="row">
    <label>Nome piatto</label><br/>
    <input id="title" placeholder="Es. Pasta alla Norma">
  </div>

  <div class="row hint">
    Posiziona il piatto su un foglio A4 (tappetino con marker opzionale). Ruota lentamente il piatto, scatta ~40–80 foto a 360°.
  </div>

  <div class="row">
    <video id="cam" playsinline muted></video>
  </div>

  <div class="row">
    <button id="start">Apri Fotocamera</button>
    <button id="shot" disabled>Scatta</button>
    <button id="finish" disabled>Finito & Carica</button>
  </div>

  <div class="row thumbs" id="thumbs"></div>
  <div class="row" id="status"></div>
</main>

<script type="module">
const cam = document.getElementById('cam');
const btnStart = document.getElementById('start');
const btnShot = document.getElementById('shot');
const btnFinish = document.getElementById('finish');
const thumbs = document.getElementById('thumbs');
const statusEl = document.getElementById('status');
const titleEl = document.getElementById('title');

let stream=null, shots=[];

/**
 * CONFIGURAZIONE GITHUB
 * Sostituisci OWNER/REPO con i valori reali del tuo repository GitHub Pages.
 * Branch tipico: 'main' (o 'master' se usi quello).
 * Il token va passato tramite hash nella URL quando usi TU la pagina: #token=GHP_xxx
 */
const repoOwner = "OWNER";   // <-- METTI IL TUO USER/GITHUB ORG
const repoName  = "REPO";    // <-- METTI IL NOME DEL REPO
const branch    = "main";
const token     = new URL(location.href).hash.split('token=')[1] || ""; // usa link con #token=... quando carichi TU

function setStatus(t){ statusEl.textContent = t; }
function b64(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }

btnStart.onclick = async () => {
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
    cam.srcObject = stream; await cam.play();
    btnShot.disabled = false; btnFinish.disabled = false; btnStart.disabled = true;
  }catch(e){ setStatus("Permesso camera negato: " + e.message); }
};

btnShot.onclick = async () => {
  try{
    const track = cam.srcObject.getVideoTracks()[0];
    const cap = new ImageCapture(track);
    const bmp = await cap.grabFrame();
    const c = document.createElement('canvas'); c.width=bmp.width; c.height=bmp.height;
    const ctx = c.getContext('2d'); ctx.drawImage(bmp,0,0);
    // downscale (facoltativo) per upload più leggero
    const maxW = 2048;
    if (c.width>maxW){
      const r=maxW/c.width; const c2=document.createElement('canvas'); c2.width=maxW; c2.height=c.height*r;
      c2.getContext('2d').drawImage(c,0,0,c2.width,c2.height);
      c.width=c2.width; c.height=c2.height; ctx.drawImage(c2,0,0);
    }
    const blob = await new Promise(res=>c.toBlob(res,'image/jpeg',0.9));
    shots.push(blob);
    const img = document.createElement('img'); img.src=URL.createObjectURL(blob); thumbs.appendChild(img);
    setStatus(`Foto scattate: ${shots.length}`);
  }catch(e){
    setStatus("Errore scatto: " + e.message);
  }
};

async function githubRequest(path, method, body){
  const r = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
    method, headers:{
      'Authorization': `token ${token}`,
      'Content-Type': 'application/json'
    }, body: body ? JSON.stringify(body) : undefined
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

async function getFileSha(path){
  const r = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}?ref=${branch}`, {
    headers: { 'Authorization': `token ${token}` }
  });
  if (r.status===404) return null;
  const j = await r.json(); return j.sha;
}

btnFinish.onclick = async () => {
  if(!token){ alert("Aggiungi #token=GITHUB_TOKEN alla URL per autorizzare l'upload (solo per te/admin)."); return; }
  if(shots.length<20){ if(!confirm("Hai meno di 20 foto, continuare?")) return; }
  const title = (titleEl.value||"Piatto").trim();
  const id = (Date.now().toString(36)+Math.random().toString(36).slice(2,7)).toLowerCase();
  const base = `uploads/${id}`;
  setStatus("Caricamento in corso…");

  // 1) crea cartella con README (Git richiede un file per creare la cartella)
  await githubRequest(`${base}/README.txt`, 'PUT', {
    message: `create ${base}`,
    branch,
    content: btoa("upload in progress")
  });

  // 2) carica immagini
  let idx=0;
  for (const blob of shots){
    const buf = await blob.arrayBuffer();
    const name = `img_${String(idx++).padStart(4,'0')}.jpg`;
    await githubRequest(`${base}/${name}`, 'PUT', {
      message: `upload ${name}`,
      branch,
      content: b64(buf)
    });
    setStatus(`Caricamento… ${idx}/${shots.length}`);
  }

  // 3) aggiorna indice (data/index.json) appendendo l’elemento “queued”
  let index=[], sha=null;
  try{
    const r = await fetch(`https://raw.githubusercontent.com/${repoOwner}/${repoName}/${branch}/data/index.json?${Date.now()}`);
    if (r.ok) index = await r.json();
  }catch{}
  sha = await getFileSha('data/index.json');
  index.push({ id, title, status:'queued', createdAt: Date.now() });

  await githubRequest('data/index.json', 'PUT', {
    message: `index add ${id}`,
    branch,
    content: btoa(unescape(encodeURIComponent(JSON.stringify(index,null,2)))),
    sha
  });

  setStatus("Fatto! La ricostruzione partirà in automatico. Puoi chiudere la pagina.");
  btnShot.disabled = true; btnFinish.disabled = true;
};
</script>
</body>
</html>
