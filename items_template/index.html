<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Piatto 3D</title>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<style>
  :root{--bg:#000;--panel:#0f0f0f;--muted:#aaa;--ok:#1f6f3f;--warn:#e6a23c;--err:#e35d5d;--accent:#2d6cdf}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#fff;font:14px system-ui,-apple-system,Segoe UI,Roboto}
  #status{padding:14px 16px;background:var(--panel);border-bottom:1px solid #1e1e1e}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .badge{padding:4px 10px;border-radius:999px;font-weight:600;background:#222}
  .b-blocked{background:#3a1818}
  .b-prepare{background:#182338}
  .b-mvs{background:#153024}
  .b-convert{background:#332418}
  .b-ready{background:#16381f}
  .b-error{background:#3a1717}
  progress{width:100%;height:10px;appearance:none}
  #msg{margin-top:6px;color:var(--muted)}
  .warn{color:var(--warn)} .err{color:var(--err)}
  #tips{margin-top:10px;color:var(--muted)}
  model-viewer{width:100vw;height:90vh;display:none;background:#000}
  #dl{padding:10px;display:none}
  a{color:var(--accent)}
</style>
</head>
<body>

<div id="status">
  <div class="row">
    <div id="badge" class="badge">Inizializzo…</div>
    <div id="phaseTxt">Fase: —</div>
  </div>
  <div style="margin-top:8px">
    <progress id="bar" max="100" value="0"></progress>
    <div id="msg"></div>
    <div id="tips"></div>
  </div>
</div>

<model-viewer id="mv"
  src="model.glb" ios-src="model.usdz"
  camera-controls shadow-intensity="0.7" environment-image="neutral"
  ar ar-modes="webxr scene-viewer quick-look">
</model-viewer>

<div id="dl">
  <b>Scarica varianti:</b>
  <a href="model.glb">GLB</a> ·
  <a href="model.draco.glb">GLB Draco</a> ·
  <a href="model.ktx2.glb">GLB KTX2</a> ·
  <a href="model.usdz">USDZ</a>
</div>

<script>
const MIN_REQUIRED = 20, MIN_RECOMMENDED = 40;

function badgeClass(phase){
  return ({
    blocked:'b-blocked', prepare:'b-prepare', mvs:'b-mvs',
    convert:'b-convert', ready:'b-ready', error:'b-error'
  })[phase] || '';
}
function human(phase){
  return ({
    queued:'In coda', blocked:'In attesa di più foto', prepare:'Preparo immagini',
    mvs:'Densificazione e mesh', convert:'Conversione GLB', ready:'Pronto', error:'Errore'
  })[phase] || phase || '—';
}
function renderTips(phase, msg){
  const el = document.getElementById('tips');
  let html = '';
  if (phase === 'blocked') {
    html = `
      <div class="err"><b>Servono più scatti</b></div>
      <ul>
        <li>Carica <b>almeno ${MIN_REQUIRED}</b> foto (consigliate <b>${MIN_RECOMMENDED}+</b>).</li>
        <li>Scatta intorno all’oggetto con buona sovrapposizione (60–80%).</li>
        <li>Evita blur e superfici piatte/luccicanti.</li>
      </ul>`;
  } else if (msg && msg.includes('consigliato')) {
    html = `<div class="warn">Poche foto: ${msg}</div>`;
  }
  el.innerHTML = html;
}

async function getStatus(){
  const r = await fetch('status.json?'+Date.now());
  if (!r.ok) return null;
  return r.json();
}

async function tick(){
  try{
    let st = await getStatus();
    if (!st) return;

    const badge = document.getElementById('badge');
    badge.className = 'badge ' + badgeClass(st.phase);
    badge.textContent = human(st.phase);

    document.getElementById('phaseTxt').textContent = 'Fase: ' + human(st.phase);
    document.getElementById('bar').value = st.percent || 0;

    const msgEl = document.getElementById('msg');
    msgEl.textContent = st.msg || '';
    msgEl.className = (st.phase === 'error' || st.phase === 'blocked') ? 'err'
                    : (st.msg && st.msg.includes('consigliato')) ? 'warn' : '';

    renderTips(st.phase, st.msg || '');

    // Quando pronto → mostra viewer e download, nascondi status
    if (st.phase === 'ready') {
      document.getElementById('mv').style.display = 'block';
      document.getElementById('dl').style.display = 'block';
      document.getElementById('status').style.display = 'none';
    }
  }catch(e){}
}

tick();
setInterval(tick, 4000);
</script>
</body>
</html>
